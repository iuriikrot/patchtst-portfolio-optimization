# –ü–ª–∞–Ω –ø—Ä–æ–µ–∫—Ç–∞ –í–ö–†: –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å PatchTST

**–°—Ç–∞—Ç—É—Å:** v1.1 - –ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 20.01.2026

–ü–ª–∞–Ω —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –ø–æ—à–∞–≥–æ–≤—É—é —Ä–∞–±–æ—Ç—É: –∫–∞–∂–¥—ã–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
–∏ —Å–æ–≥–ª–∞—Å—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É.

**–í–ê–ñ–ù–û:** –ú–æ–¥–µ–ª—å PatchTST –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ Self-Supervised –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
https://github.com/yuqinie98/PatchTST

---

## ‚úÖ –®–∞–≥ 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–¶–µ–ª—å:** –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–∞—è —Å—Ä–µ–¥–∞ –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
- **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
  - Python 3.x —Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
  - PyTorch —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π MPS (Apple Silicon) / CUDA / CPU
  - statsforecast –¥–ª—è AutoARIMA
  - scikit-learn –¥–ª—è Ledoit-Wolf –∫–æ–≤–∞—Ä–∏–∞—Ü–∏–∏
  - matplotlib, seaborn –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í—Å–µ –ø–∞–∫–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## ‚úÖ –®–∞–≥ 2. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–¶–µ–ª—å:** –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
- **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** `config/config.yaml`

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±—ç–∫—Ç–µ—Å—Ç–∞:
```yaml
backtest:
  train_window: 1260        # 5 –ª–µ—Ç (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π)
  test_window: 21           # 1 –º–µ—Å—è—Ü (—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞)

optimization:
  risk_free_rate: 0.04      # 4% –≥–æ–¥–æ–≤—ã—Ö
  covariance: "ledoit_wolf" # –ú–µ—Ç–æ–¥ –æ—Ü–µ–Ω–∫–∏ –∫–æ–≤–∞—Ä–∏–∞—Ü–∏–∏

  constraints:
    long_only: true         # –¢–æ–ª—å–∫–æ –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    fully_invested: true    # –°—É–º–º–∞ –≤–µ—Å–æ–≤ = 100%
    min_weight: 0.05        # –ú–∏–Ω–∏–º—É–º 5% –≤ –∫–∞–∂–¥—ã–π –∞–∫—Ç–∏–≤
    max_weight: 0.25        # –ú–∞–∫—Å–∏–º—É–º 25% –≤ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** Constraints (min=5%, max=25%) –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—é. –° 10 –∞–∫—Ç–∏–≤–∞–º–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤–µ—Å–æ–≤ = 50%, —á—Ç–æ –ø—Ä–∏–Ω—É–∂–¥–∞–µ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å –¥–µ—Ä–∂–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤—ã.

### –ú–æ–¥–µ–ª–∏:

**Baseline 1:** –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ
**Baseline 2:** StatsForecast AutoARIMA (max_p=3, max_d=0, max_q=3)
**PatchTST:** Self-Supervised (input=1260, patch=16, stride=8, pretrain_epochs=30)

---

## ‚úÖ –®–∞–≥ 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–î–∞–Ω–Ω—ã–µ:** S&P 500, 10 –∞–∫—Ç–∏–≤–æ–≤
- **–¢–∏–∫–µ—Ä—ã:** AAPL, CVX, JNJ, JPM, KO, MSFT, PG, UNH, WFC, XOM
- **–ü–µ—Ä–∏–æ–¥:** 2000-01-01 ‚Äî 2025-01-01
- **–ò—Å—Ç–æ—á–Ω–∏–∫:** Adjusted Close (—É—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∏–≤–∏–¥–µ–Ω–¥—ã –∏ —Å–ø–ª–∏—Ç—ã)
- **–§–∞–π–ª:** `data/raw/prices.csv`

---

## ‚úÖ –®–∞–≥ 4. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ª–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–æ—Ä–º—É–ª–∞:** `log(P_t / P_{t-1})`
- **–û–±—Ä–∞–±–æ—Ç–∫–∞:** –£–¥–∞–ª–µ–Ω—ã NaN (dropna –ø–æ —Å—Ç—Ä–æ–∫–∞–º)
- **–§–∞–π–ª:** `data/raw/log_returns.csv`
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ù–µ—Ç inf/NaN, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º

---

## ‚úÖ –®–∞–≥ 5. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- –ù–µ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤ –¥–∞—Ç, –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
- Train/test –æ–∫–Ω–∞ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è (walk-forward)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ data leakage –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

---

## ‚úÖ –®–∞–≥ 6. Baseline 1: Historical Mean

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–∞–π–ª:** `src/backtesting/backtest.py`
- **Œº:** –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ √ó 252 (–≥–æ–¥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å)
- **Œ£:** Ledoit-Wolf –∫–æ–≤–∞—Ä–∏–∞—Ü–∏—è √ó 252
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** maximize_sharpe —Å constraints
- **–†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞:** –†–∞–∑ –≤ –º–µ—Å—è—Ü (21 –¥–µ–Ω—å)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:** –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `results/baseline1_*.csv`

---

## ‚úÖ –®–∞–≥ 7. Baseline 2: StatsForecast AutoARIMA

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–∞–π–ª:** `src/backtesting/backtest_statsforecast.py`
- **Œº:** mean(forecast_21_days) √ó 252
- **–ü—Ä–æ–≥–Ω–æ–∑:** ARIMA(p‚â§3, d=0, q‚â§3) —Å stepwise=True (—É—Å–∫–æ—Ä–µ–Ω–∏–µ)
- **Fallback:** –ï—Å–ª–∏ ARIMA –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è ‚Üí –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:** –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `results/statsforecast_*.csv`

---

## ‚úÖ –®–∞–≥ 8. PatchTST Self-Supervised

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–∞–π–ª:** `src/backtesting/backtest_patchtst.py`
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Official PatchTST (https://github.com/yuqinie98/PatchTST)
- **–†–µ–∂–∏–º:** Self-Supervised pretrain + supervised finetune
- **Œº:** mean(forecast_21_days) √ó 252

### –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –±—ç–∫—Ç–µ—Å—Ç–∞:
1. **Pretrain:** –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—á–µ–π (40%), –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (30 epochs)
2. **Finetune:** Supervised –æ–±—É—á–µ–Ω–∏–µ prediction head (10 epochs)
3. **Forecast:** –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 21 –¥–µ–Ω—å
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ú–∞—Ä–∫–æ–≤–∏—Ü —Å –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–º–∏ Œº

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- Input length: 1260 (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ —Å baselines)
- Patch length: 16, stride: 8 ‚Üí 156 –ø–∞—Ç—á–µ–π
- d_model: 128, n_heads: 16, n_layers: 3
- Device: MPS (Apple Silicon) / CUDA / CPU (–∞–≤—Ç–æ–≤—ã–±–æ—Ä)

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:** –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `results/patchtst_*.csv`

---

## ‚úÖ –®–∞–≥ 9. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ (v1.1)

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–∞–π–ª:** `src/utils/forecast_metrics.py`
- **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
  - RMSE: ‚àö(mean((actual - predicted)¬≤))
  - MAE: mean(|actual - predicted|)
  - Hit Rate: —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∑–Ω–∞–∫–æ–≤ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤:
- **Actual:** –°—É–º–º–∞ –¥–Ω–µ–≤–Ω—ã—Ö –ª–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π –∑–∞ –º–µ—Å—è—Ü
- **Predicted:** –°—É–º–º–∞ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –∑–∞ –º–µ—Å—è—Ü
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è:** –ü–æ –≤—Å–µ–º –ø–µ—Ä–∏–æ–¥–∞–º –∏ —Ç–∏–∫–µ—Ä–∞–º

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:** `results/*_forecasts_{timestamp}.csv`

---

## ‚úÖ –®–∞–≥ 10. –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (v1.1)

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

### –ú–µ—Ç—Ä–∏–∫–∏:
1. **Annual Return:** CAGR (–º–µ—Å—è—á–Ω—ã–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ ‚Üí –≥–æ–¥–æ–≤—ã–µ)
2. **Annual Volatility:** std(returns) √ó ‚àö12
3. **Sharpe Ratio:** (Œº - rf) / œÉ √ó ‚àö12
4. **Calmar Ratio:** Annual Return / |Max Drawdown| ‚≠ê NEW
5. **Max Drawdown:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞ –æ—Ç –ø–∏–∫–∞
6. **Total Return:** –û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∑–∞ –ø–µ—Ä–∏–æ–¥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏:
- ‚úÖ –õ–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ ‚Üí –ø—Ä–æ—Å—Ç—ã–µ –¥–ª—è –º–µ—Ç—Ä–∏–∫
- ‚úÖ Risk-free –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: –≥–æ–¥–æ–≤–∞—è (4%) ‚Üí –º–µ—Å—è—á–Ω–∞—è
- ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–µ—Ä–∏–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:** `results/comparison_{timestamp}.csv`, `results/metrics_{timestamp}.json`

---

## ‚úÖ –®–∞–≥ 11. –ê–Ω–∞–ª–∏–∑ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ (v1.1)

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–∞–π–ª:** –°–µ–∫—Ü–∏—è 8 –≤ `notebooks/01_portfolio_comparison.ipynb`

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
1. **Turnover:** –°—Ä–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–µ—Å–æ–≤ –º–µ–∂–¥—É –ø–µ—Ä–∏–æ–¥–∞–º–∏
   - Formula: Œ£|w_t - w_{t-1}| / 2
2. **Heatmaps:** –í–µ—Å–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
3. **–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –≤–µ—Å–æ–≤:** –î–∏–Ω–∞–º–∏–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–∞
4. **–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –≤–µ—Å–æ–≤:** std(weights) –ø–æ –∞–∫—Ç–∏–≤–∞–º

### –í—ã–≤–æ–¥—ã:
- **Baseline 1:** –ù–∏–∑–∫–∏–π turnover (~2.8%), —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –≤–µ—Å–∞
- **Baseline 2:** –°—Ä–µ–¥–Ω–∏–π turnover (~15%), —É–º–µ—Ä–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **PatchTST:** –í—ã—Å–æ–∫–∏–π turnover (~33%), –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** Constraints (5-25%) –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤—ã–≤–æ–¥–µ

---

## ‚úÖ –®–∞–≥ 12. –ü–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ (v1.1)

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–∞–π–ª:** `run_all.py`
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
  - –í—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥–∏: `--baseline1`, `--baseline2`, `--patchtst`
  - –†–µ–∂–∏–º PatchTST: `--fast` –∏–ª–∏ –ø–æ–ª–Ω—ã–π —Ä–µ–∂–∏–º
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å timestamp
  - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: –ì—Ä–∞—Ñ–∏–∫ –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã—Ö –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π

### –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
1. –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (—Ç–∞–±–ª–∏—Ü–∞)
2. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ (—Ç–∞–±–ª–∏—Ü–∞)
3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: CSV, JSON, PNG
4. –ì—Ä–∞—Ñ–∏–∫: `results/cumulative_returns_{timestamp}.png`

**–ó–∞–ø—É—Å–∫:**
```bash
python run_all.py --baseline1 --baseline2 --patchtst
```

---

## ‚úÖ –®–∞–≥ 13. Jupyter Notebook (v1.1)

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

- **–§–∞–π–ª:** `notebooks/01_portfolio_comparison.ipynb`
- **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:** .py ‚Üí .ipynb —á–µ—Ä–µ–∑ jupytext
- **Google Colab:** –ì–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ config.yaml
3. Baseline 1: Historical Mean
4. Baseline 2: StatsForecast AutoARIMA
5. PatchTST Self-Supervised
6. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç–∞–±–ª–∏—Ü—ã + –≥—Ä–∞—Ñ–∏–∫–∏)
7. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
8. –ê–Ω–∞–ª–∏–∑ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π

---

## ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞ (Latest)

**–°—Ç–∞—Ç—É—Å:** –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

### –ü—Ä–æ–±–ª–µ–º–∞:
–í—ã–≤–æ–¥ `weights: [5.00%, 25.00%]` –ø–æ–∫–∞–∑—ã–≤–∞–ª —Ç–æ–ª—å–∫–æ min/max, —á—Ç–æ –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –∏–∑-–∑–∞ constraints.

### –†–µ—à–µ–Ω–∏–µ:
–ó–∞–º–µ–Ω—ë–Ω –Ω–∞ **—Ç–æ–ø-3 –∞–∫—Ç–∏–≤–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º–∏ –≤–µ—Å–∞–º–∏:**

**–ë—ã–ª–æ:**
```
–®–∞–≥ 1: 2015-01-07
  weights: [5.00%, 25.00%]  # –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ
```

**–°—Ç–∞–ª–æ:**
```
–®–∞–≥ 1: 2015-01-07 | top-3: UNH:25.0%, AAPL:23.4%, WFC:16.6%
```

**–§–∞–π–ª—ã:**
- `src/backtesting/backtest.py`
- `src/backtesting/backtest_statsforecast.py`
- `src/backtesting/backtest_patchtst.py`

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- [x] –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (10 –∞–∫—Ü–∏–π S&P 500, 2000-2025)
- [x] Baseline 1: –ú–∞—Ä–∫–æ–≤–∏—Ü —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º —Å—Ä–µ–¥–Ω–∏–º
- [x] Baseline 2: StatsForecast AutoARIMA
- [x] PatchTST Self-Supervised (input=1260, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ —Å baselines)
- [x] –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª–µ–π: Annual Return, Volatility, Sharpe, Calmar, Drawdown
- [x] –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: RMSE, MAE, Hit Rate
- [x] –ê–Ω–∞–ª–∏–∑ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏: Turnover, heatmaps, —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –≤–µ—Å–æ–≤
- [x] –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: –ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏, –≥—Ä–∞—Ñ–∏–∫–∏ –≤–µ—Å–æ–≤
- [x] –ü–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫: run_all.py —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- [x] Jupyter Notebook: –ì–æ—Ç–æ–≤ –¥–ª—è Google Colab

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:
```
VKR_Patch/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ config.yaml                 # –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ raw/
‚îÇ       ‚îú‚îÄ‚îÄ prices.csv              # Adjusted Close
‚îÇ       ‚îî‚îÄ‚îÄ log_returns.csv         # –õ–æ–≥-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ backtesting/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backtest.py            # Baseline 1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backtest_statsforecast.py  # Baseline 2
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backtest_patchtst.py   # PatchTST
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ patchtst.py            # PatchTST Self-Supervised
‚îÇ   ‚îú‚îÄ‚îÄ optimization/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ markowitz.py           # –ú–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è Sharpe
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ covariance.py          # Ledoit-Wolf
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ forecast_metrics.py    # RMSE, MAE, Hit Rate
‚îú‚îÄ‚îÄ notebooks/
‚îÇ   ‚îî‚îÄ‚îÄ 01_portfolio_comparison.ipynb  # –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
‚îú‚îÄ‚îÄ run_all.py                     # –ü–∞–∫–µ—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫
‚îî‚îÄ‚îÄ results/                       # –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    ‚îú‚îÄ‚îÄ *_returns_{timestamp}.csv
    ‚îú‚îÄ‚îÄ *_weights_{timestamp}.csv
    ‚îú‚îÄ‚îÄ *_forecasts_{timestamp}.csv
    ‚îú‚îÄ‚îÄ comparison_{timestamp}.csv
    ‚îú‚îÄ‚îÄ metrics_{timestamp}.json
    ‚îî‚îÄ‚îÄ cumulative_returns_{timestamp}.png
```

---

## üîç –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. Constraints –Ω–∞ –≤–µ—Å–∞
**–¢–µ–∫—É—â–∏–µ:** min=5%, max=25%

**–í–ª–∏—è–Ω–∏–µ:**
- –° 10 –∞–∫—Ç–∏–≤–∞–º–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ = 50%
- –ü–æ—Ä—Ç—Ñ–µ–ª—å –ø—Ä–∏–Ω—É–∂–¥—ë–Ω–Ω–æ –¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤—ã
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –≤ –ª—É—á—à–∏—Ö –∞–∫—Ç–∏–≤–∞—Ö

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤:**
- `min=0.0, max=0.40` - –±–æ–ª—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏
- `min=0.0, max=1.0` - –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ú–∞—Ä–∫–æ–≤–∏—Ü)

### 2. Risk-free rate
**–¢–µ–∫—É—â–∞—è:** 4% (–≥–æ–¥–æ–≤–∞—è)
**–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:** (1 + 0.04)^(1/12) - 1 –¥–ª—è –º–µ—Å—è—á–Ω–æ–≥–æ Sharpe

### 3. –ö–æ–≤–∞—Ä–∏–∞—Ü–∏—è
**–ú–µ—Ç–æ–¥:** Ledoit-Wolf (—Ä–æ–±–∞—Å—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞)
**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** Sample covariance (`covariance: "sample"` –≤ config)

### 4. PatchTST –æ–±—É—á–µ–Ω–∏–µ
- **Pretrain + Finetune –Ω–∞ –∫–∞–∂–¥–æ–º –ø–µ—Ä–∏–æ–¥–µ** (–≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ –∑–∞—Ç—Ä–∞—Ç–Ω–æ)
- **–†–µ–∂–∏–º—ã:** fast (10 epochs) vs full (30 epochs)
- **Device:** –ê–≤—Ç–æ–≤—ã–±–æ—Ä MPS/CUDA/CPU

### 5. –°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã
- **Baseline 1:** ~1 –º–∏–Ω
- **Baseline 2 (ARIMA):** ~10-15 –º–∏–Ω
- **PatchTST (full):** ~2-3 —á–∞—Å–∞

---

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
   - –†–∞–∑–Ω—ã–µ constraints (min=0%, max=40%)
   - –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã –∫–æ–≤–∞—Ä–∏–∞—Ü–∏–∏ (shrinkage, exponential)
   - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ risk measures (CVaR, MAD)

2. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏:**
   - LSTM/GRU –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
   - Naive –ø—Ä–æ–≥–Ω–æ–∑ (random walk)
   - –ê–Ω—Å–∞–º–±–ª–∏ –º–æ–¥–µ–ª–µ–π

3. **–ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤:**
   - Value at Risk (VaR)
   - Conditional VaR (CVaR)
   - Tail risk metrics

4. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏:**
   - –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π
   - –í–ª–∏—è–Ω–∏–µ turnover –Ω–∞ —á–∏—Å—Ç—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å

---

## üìù –í–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

- **v1.0** (16.01.2026): –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è 3 –º–æ–¥–µ–ª–µ–π
- **v1.1** (20.01.2026):
  - ‚úÖ Forecast metrics (RMSE, MAE, Hit Rate)
  - ‚úÖ Calmar Ratio
  - ‚úÖ Portfolio rebalancing analysis
  - ‚úÖ Visualization in run_all.py
  - ‚úÖ Improved weights display (top-3)
  - ‚úÖ Jupyter Notebook update

---

## üéì –î–ª—è –í–ö–† (–¥–∏–ø–ª–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç—ã)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø–∏—Å–∞–Ω–∏—è –≤ —Ä–∞–±–æ—Ç–µ:

1. **–í–≤–µ–¥–µ–Ω–∏–µ:**
   - –ü—Ä–æ–±–ª–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ –æ–∂–∏–¥–∞–µ–º–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ Œº
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –∏ ML –ø–æ–¥—Ö–æ–¥–æ–≤

2. **–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:**
   - –ú–∞—Ä–∫–æ–≤–∏—Ü –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
   - Walk-forward backtesting (5 –ª–µ—Ç train / 1 –º–µ—Å—è—Ü test)
   - –¢—Ä–∏ –ø–æ–¥—Ö–æ–¥–∞ –∫ –æ—Ü–µ–Ω–∫–µ Œº

3. **–ú–æ–¥–µ–ª–∏:**
   - Baseline 1: –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ (benchmark)
   - Baseline 2: ARIMA –ø—Ä–æ–≥–Ω–æ–∑ (—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π)
   - PatchTST: Self-Supervised transformer (ML)

4. **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
   - –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (Sharpe, Calmar, Drawdown)
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ (RMSE, MAE, Hit Rate)
   - –ê–Ω–∞–ª–∏–∑ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ (turnover, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≤–µ—Å–æ–≤)

5. **–í—ã–≤–æ–¥—ã:**
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π
   - –í–ª–∏—è–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—å
   - Trade-off –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é

### –ö–ª—é—á–µ–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã:
- –ö—É–º—É–ª—è—Ç–∏–≤–Ω—ã–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
- Heatmap –≤–µ—Å–æ–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è
- Turnover —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
- Drawdown —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏

---

**–ê–≤—Ç–æ—Ä:** Iurii Krotov
**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** https://github.com/iuriikrot/VKR_Patch
**–õ–∏—Ü–µ–Ω–∑–∏—è:** Apache 2.0 (PatchTST reference code)
